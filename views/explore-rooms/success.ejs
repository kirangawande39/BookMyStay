<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Payment Successful</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- EmailJS, html2pdf, QRCode -->
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    (function () {
      emailjs.init("tsg_InKx5zF2PHZxd");
    })();
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-blue-100 flex items-center justify-center font-sans">

  <div class="max-w-4xl w-full bg-white/80 backdrop-blur-lg shadow-2xl rounded-2xl p-10 relative" id="receipt">

    <!-- Back -->
    <a href="/explore-rooms" class="absolute top-6 left-6 text-gray-500 hover:text-gray-800 text-2xl">
      <i class="bi bi-arrow-left-circle-fill"></i>
    </a>

    <!-- Success Header -->
    <div class="text-center mb-8">
      <div class="mx-auto w-20 h-20 bg-green-100 rounded-full flex items-center justify-center">
        <i class="bi bi-check2-circle text-green-600 text-5xl"></i>
      </div>
      <h2 class="text-3xl font-bold text-green-700 mt-4">Payment Successful</h2>
      <p class="text-gray-600 mt-2">
        Thank you, <span class="font-semibold"><%= booking.user.username %></span>.  
        Your booking is confirmed üéâ
      </p>
    </div>

    <!-- Content Grid -->
    <div class="grid md:grid-cols-2 gap-8">
      
      <!-- Booking Details -->
      <div class="space-y-4 bg-gray-50 rounded-xl p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-gray-800"><%= booking.listing.title %></h3>
        <p><span class="font-medium">üìç Location:</span> <%= booking.listing.location %></p>
        <p><span class="font-medium">üìÖ Dates:</span> 
          <%= new Date(booking.startDate).toLocaleDateString() %> ‚Üí <%= new Date(booking.endDate).toLocaleDateString() %>
        </p>
        <p><span class="font-medium">üí∞ Price per Night:</span> ‚Çπ<%= booking.listing.price %></p>
        <p><span class="font-medium">üí≥ Total Paid:</span> 
          <span class="text-lg font-bold text-green-600">‚Çπ<%= booking.totalPrice %></span>
        </p>
        <p class="text-green-600 font-semibold">Status: <%= booking.status %></p>
      </div>

      <!-- QR + Actions -->
      <div class="flex flex-col items-center justify-center bg-white rounded-xl p-6 shadow-sm">
        <div id="qrcode" class="mb-6"></div>
        <p class="text-sm text-gray-500 mb-6">Scan to verify your booking</p>

        <button onclick="downloadReceipt()" 
          class="w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-700 text-white rounded-lg shadow-md hover:scale-105 transition">
          <i class="bi bi-download mr-2"></i> Download Receipt
        </button>

        <a href="/explore-rooms" 
          class="mt-3 w-full px-6 py-3 bg-gradient-to-r from-emerald-500 to-emerald-700 text-white rounded-lg shadow-md hover:scale-105 transition text-center">
          <i class="bi bi-house-door mr-2"></i> Back to Home
        </a>
      </div>
    </div>
  </div>

  <!-- Hidden Email Form -->
  <form id="contact-form" class="hidden">
    <input type="hidden" name="to_email" value="<%= booking.user.email %>" />
    <input type="hidden" name="user_name" value="<%= booking.user.username %>" />
    <input type="hidden" name="user_email" value="<%= booking.user.email %>" />
    <input type="hidden" name="price" value="<%= booking.totalPrice %>" />
    <input type="hidden" name="message" value="Thank you for your booking. Your stay at <%= booking.listing.title %> from <%= new Date(booking.startDate).toLocaleDateString() %> to <%= new Date(booking.endDate).toLocaleDateString() %> has been confirmed. Total paid: ‚Çπ<%= booking.totalPrice %>." />
  </form>

  <script>
    function downloadReceipt() {
      const qrCanvas = document.querySelector('#qrcode canvas');
      if (qrCanvas) {
        const img = document.createElement('img');
        img.src = qrCanvas.toDataURL('image/png');
        img.classList.add("w-28", "h-28");

        const qrCodeDiv = document.getElementById('qrcode');
        qrCodeDiv.innerHTML = '';
        qrCodeDiv.appendChild(img);

        setTimeout(() => {
          const element = document.getElementById("receipt");
          html2pdf(element, {
            margin: 10,
            filename: 'Booking_Receipt.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { format: 'a4', orientation: 'portrait' }
          });
        }, 500);
      } else {
        alert("QR Code not found.");
      }
    }

    // QR + Email
    window.onload = function () {
      new QRCode(document.getElementById("qrcode"), {
        text: `https://rentspheres.onrender.com/owner/verify-booking?bookingId=<%= booking._id %>`,
        width: 140,
        height: 140
      });

      emailjs.sendForm("service_n6tispg", "template_ysmu9b9", document.getElementById("contact-form"))
        .then(() => console.log("üìß Email sent"))
        .catch((error) => console.error("‚ùå Email failed:", error));
    };
  </script>

</body>
</html>
